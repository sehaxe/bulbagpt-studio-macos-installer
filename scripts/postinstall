#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
APP_DIR="/Applications/BulbaGPT"
MINIFORGE_DIR="$APP_DIR/miniforge3"
CONDA_ENV_NAME="bulbagpt_env"
PYTHON_VERSION="3.10"
LOG_FILE="$APP_DIR/install_log.txt"

# –ù–∞—á–∏–Ω–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
exec > "$LOG_FILE" 2>&1

echo "--- –ù–ê–ß–ê–õ–û POSTINSTALL: $(date) ---"

# 1. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –†–ï–ê–õ–¨–ù–û–ì–û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø
# –£—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ root, –Ω–æ –≤–ª–∞–¥–µ–ª—å—Ü–µ–º —Ñ–∞–π–ª–æ–≤ –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
CURRENT_USER=$(scutil <<< "show State:/Users/ConsoleUser" | awk '/Name :/ { print $3 }')
echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã: $CURRENT_USER"

# 2. –£–°–¢–ê–ù–û–í–ö–ê MINIFORGE (Conda)
if [ ! -d "$MINIFORGE_DIR" ]; then
    echo "‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Miniforge..."
    
    ARCH=$(uname -m)
    if [ "$ARCH" == "arm64" ]; then
        URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-arm64.sh"
    else
        URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-x86_64.sh"
    fi
    
    curl -L -o /tmp/miniforge.sh "$URL"
    
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Miniforge –≤ $MINIFORGE_DIR..."
    bash /tmp/miniforge.sh -b -u -p "$MINIFORGE_DIR"
    rm /tmp/miniforge.sh
else
    echo "‚úÖ Miniforge —É–∂–µ –µ—Å—Ç—å."
fi

# 3. –°–û–ó–î–ê–ù–ò–ï –û–ö–†–£–ñ–ï–ù–ò–Ø
# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º conda –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
source "$MINIFORGE_DIR/bin/activate"

if ! conda info --envs | grep -q "$CONDA_ENV_NAME"; then
    echo "üî® –°–æ–∑–¥–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è $CONDA_ENV_NAME (Python $PYTHON_VERSION)..."
    conda create -y -n "$CONDA_ENV_NAME" python="$PYTHON_VERSION"
fi

# 4. –£–°–¢–ê–ù–û–í–ö–ê –ë–ò–ë–õ–ò–û–¢–ï–ö (PIP)
# –ò—â–µ–º requirements.txt. –û–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –∫–æ—Ä–µ–Ω—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–æ–º build.sh
REQ_FILE="$APP_DIR/requirements.txt"

if [ -f "$REQ_FILE" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ —á–µ—Ä–µ–∑ pip –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ..."
    # –ó–∞–ø—É—Å–∫–∞–µ–º pip –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏–∑ –Ω–∞—à–µ–≥–æ –Ω–æ–≤–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    "$MINIFORGE_DIR/envs/$CONDA_ENV_NAME/bin/pip" install -r "$REQ_FILE"
else
    echo "‚ö†Ô∏è requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $APP_DIR"
fi

# 5. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í –î–û–°–¢–£–ü–ê (–°–ê–ú–û–ï –í–ê–ñ–ù–û–ï!)
# –¢–∞–∫ –∫–∞–∫ –º—ã —Å—Ç–∞–≤–∏–ª–∏ –≤—Å—ë –æ—Ç –∏–º–µ–Ω–∏ Root, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–º–æ–∂–µ—Ç —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è.
# –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –≤—Å–µ–π –ø–∞–ø–∫–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
if [ -n "$CURRENT_USER" ] && [ "$CURRENT_USER" != "loginwindow" ]; then
    echo "üë§ –ü–µ—Ä–µ–¥–∞—á–∞ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é $CURRENT_USER..."
    chown -R "$CURRENT_USER:staff" "$APP_DIR"
fi

# –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞–º
chmod -R 755 "$APP_DIR"

echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
exit 0
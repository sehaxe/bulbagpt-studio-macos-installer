#!/bin/bash

# –ü—É—Ç–∏
APP_DIR="/Applications/BulbaGPT"
MINIFORGE_DIR="$APP_DIR/miniforge3"
CONDA_ENV_NAME="bulbagpt_env"
PYTHON_VERSION="3.10"
LOG_FILE="$APP_DIR/install_log.txt"

# –ü–∏—à–µ–º –ª–æ–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä—è–º–æ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–≥—Ä–∞–º–º—ã
exec > "$LOG_FILE" 2>&1
echo "--- INSTALL START: $(date) ---"

# 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—á—Ç–æ–±—ã –ø–æ—Ç–æ–º –æ—Ç–¥–∞—Ç—å –µ–º—É –ø—Ä–∞–≤–∞)
CURRENT_USER=$(scutil <<< "show State:/Users/ConsoleUser" | awk '/Name :/ { print $3 }')
echo "Installing for user: $CURRENT_USER"

# 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Miniforge (–µ—Å–ª–∏ –Ω–µ—Ç)
if [ ! -d "$MINIFORGE_DIR" ]; then
    echo "‚¨áÔ∏è Downloading Miniforge..."
    ARCH=$(uname -m)
    if [ "$ARCH" == "arm64" ]; then
        URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-arm64.sh"
    else
        URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-x86_64.sh"
    fi
    curl -L -o /tmp/miniforge.sh "$URL"
    echo "üì¶ Installing Miniforge..."
    bash /tmp/miniforge.sh -b -u -p "$MINIFORGE_DIR"
    rm /tmp/miniforge.sh
else
    echo "‚úÖ Miniforge exists."
fi

# 3. –°–æ–∑–¥–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
source "$MINIFORGE_DIR/bin/activate"
if ! conda info --envs | grep -q "$CONDA_ENV_NAME"; then
    echo "üî® Creating env $CONDA_ENV_NAME..."
    conda create -y -n "$CONDA_ENV_NAME" python="$PYTHON_VERSION"
fi

# 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ (pip install)
REQ_FILE="$APP_DIR/requirements.txt"
if [ -f "$REQ_FILE" ]; then
    echo "üì¶ Installing requirements..."
    "$MINIFORGE_DIR/envs/$CONDA_ENV_NAME/bin/pip" install -r "$REQ_FILE"
else
    echo "‚ö†Ô∏è requirements.txt not found in $APP_DIR"
fi

# 5. –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í (Critical Step)
# –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –ø–∞–ø–∫–∏ —Å root –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if [ -n "$CURRENT_USER" ] && [ "$CURRENT_USER" != "loginwindow" ]; then
    echo "üë§ Fixing permissions for $CURRENT_USER..."
    chown -R "$CURRENT_USER:staff" "$APP_DIR"
fi

# –î–∞–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
chmod -R 755 "$APP_DIR"

echo "‚úÖ Postinstall done."
exit 0
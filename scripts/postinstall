#!/bin/bash

APP_NAME="BulbaGPT Studio"
INSTALL_DIR="/Applications/$APP_NAME.app"
RES_DIR="$INSTALL_DIR/Contents/Resources"
SRC_DIR="$RES_DIR/src"
BIN_DIR="$RES_DIR/bin"
TOOLS_DIR="$RES_DIR/tools"
UV_BIN="$TOOLS_DIR/uv"
LOG_FILE="/tmp/bulbagpt_install.log"

exec > >(tee "$LOG_FILE") 2>&1
echo "--- INSTALL START ---"

# 1. DETECT REAL USER
CURRENT_USER=$(scutil <<< "show State:/Users/ConsoleUser" | awk '/Name :/ { print $3 }')
if [ -z "$CURRENT_USER" ] || [ "$CURRENT_USER" == "loginwindow" ]; then
    echo "âŒ No user logged in."
    exit 1
fi
echo "ðŸ‘¤ User: $CURRENT_USER"

# Function to run as user
run_as_user() { su - "$CURRENT_USER" -c "$1"; }

# 2. INSTALL HOMEBREW & GTK
ARCH=$(uname -m)
if [ "$ARCH" == "arm64" ]; then HOMEBREW_PREFIX="/opt/homebrew"; else HOMEBREW_PREFIX="/usr/local"; fi
BREW_BIN="$HOMEBREW_PREFIX/bin/brew"

# Allow finding brew in this script
export PATH="$HOMEBREW_PREFIX/bin:$PATH"

if [ ! -f "$BREW_BIN" ]; then
    echo "ðŸº Installing Homebrew..."
    # Install non-interactively
    run_as_user "NONINTERACTIVE=1 /bin/bash -c \"\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)\""
fi

echo "ðŸ“¦ Installing Libraries (GTK4, Adwaita)..."
run_as_user "$BREW_BIN install gtk4 libadwaita json-glib pkg-config make"

# 3. SETUP UV (PYTHON)
echo "ðŸ•·ï¸ Setup Python..."
chmod +x "$UV_BIN"
cd "$SRC_DIR"
"$UV_BIN" venv "$RES_DIR/venv" --python 3.11

if [ -f "uv.lock" ]; then
    "$UV_BIN" pip sync uv.lock --python "$RES_DIR/venv"
elif [ -f "requirements.txt" ]; then
    "$UV_BIN" pip install -r requirements.txt --python "$RES_DIR/venv"
else
    "$UV_BIN" pip install requests --python "$RES_DIR/venv"
fi

# 4. COMPILE C
echo "ðŸ”¨ Compiling..."
mkdir -p "$BIN_DIR"
# Ensure pkg-config finds the brew libraries we just installed
export PKG_CONFIG_PATH="$HOMEBREW_PREFIX/lib/pkgconfig:$HOMEBREW_PREFIX/share/pkgconfig"

if make -C "$SRC_DIR"; then
    if [ -f "$SRC_DIR/bulba_studio" ]; then
        mv "$SRC_DIR/bulba_studio" "$BIN_DIR/bulba_studio"
        chmod +x "$BIN_DIR/bulba_studio"
        echo "âœ… Compiled."
    else
        echo "âŒ Binary missing."
        exit 1
    fi
else
    echo "âŒ Make failed."
    exit 1
fi

# 5. PERMISSIONS
chown -R root:wheel "$INSTALL_DIR"
chmod -R 755 "$INSTALL_DIR"
chmod -R 777 "$BIN_DIR" # Ensure user can execute
xattr -cr "$INSTALL_DIR" || true

exit 0
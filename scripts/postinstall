#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
# –ï—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –ª–µ–∂–∏—Ç –≤ –ø–∞–ø–∫–µ —Å –ø—Ä–æ–µ–∫—Ç–æ–º, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
APP_DIR="/Applications/BulbaGPT"
MINIFORGE_DIR="$APP_DIR/miniforge3"
CONDA_ENV_NAME="bulbagpt_env"
PYTHON_VERSION="3.11"
LOG_FILE="$APP_DIR/install_log.txt"

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
mkdir -p "$APP_DIR"

# –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –≤ APP_DIR, –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –Ω–µ –æ—Ç—Ç—É–¥–∞
if [ "$SCRIPT_DIR" != "$APP_DIR" ]; then
    echo "üìÇ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞ –≤ $APP_DIR..."
    cp -R "$SCRIPT_DIR/"* "$APP_DIR/" 2>/dev/null || true
fi

# –í–∫–ª—é—á–∞–µ–º –∑–∞–ø–∏—Å—å –ª–æ–≥–∞
exec > >(tee "$LOG_FILE") 2>&1

echo "--- –ù–ê–ß–ê–õ–û –£–°–¢–ê–ù–û–í–ö–ò: $(date) ---"
echo "–í–µ—Ä—Å–∏—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞: 1.1 (—Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Rust)"

CURRENT_USER=$(scutil <<< "show State:/Users/ConsoleUser" | awk '/Name :/ { print $3 }')

# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Miniforge
if [ ! -d "$MINIFORGE_DIR" ]; then
    echo "‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Miniforge..."
    ARCH=$(uname -m)
    if [ "$ARCH" == "arm64" ]; then
        URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-arm64.sh"
    else
        URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-x86_64.sh"
    fi
    
    curl -L -o /tmp/miniforge.sh "$URL"
    echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ Miniforge..."
    bash /tmp/miniforge.sh -b -u -p "$MINIFORGE_DIR"
    rm /tmp/miniforge.sh
else
    echo "‚úÖ Miniforge —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
fi

# 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Conda
echo "üî® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Conda –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
source "$MINIFORGE_DIR/bin/activate"

if ! conda info --envs | grep -q "$CONDA_ENV_NAME"; then
    echo "   –°–æ–∑–¥–∞–µ–º env $CONDA_ENV_NAME (Python $PYTHON_VERSION)..."
    conda create -y -n "$CONDA_ENV_NAME" python="$PYTHON_VERSION"
else
    echo "   –û–∫—Ä—É–∂–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å."
fi

# –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ–∫—Ä—É–∂–µ–Ω–∏–µ
conda activate "$CONDA_ENV_NAME"

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ Rust (–ö–†–ò–¢–ò–ß–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï)
echo "ü¶Ä –ü—Ä–æ–≤–µ—Ä–∫–∞ Rust Toolchain..."

# –ü—Ä–æ–±—É–µ–º –ø–æ–¥—Ç—è–Ω—É—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Rust, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
if [ -f "$HOME/.cargo/env" ]; then
    source "$HOME/.cargo/env"
fi

if ! command -v cargo &> /dev/null; then
    echo "‚ö†Ô∏è Rust –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Rustup..."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    source "$HOME/.cargo/env"
else
    echo "‚úÖ Rust —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: $(cargo --version)"
fi

# 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ Python
REQ_FILE="$APP_DIR/requirements.txt"
if [ -f "$REQ_FILE" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ (pip install)..."
    pip install -r "$REQ_FILE"
    # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º maturin, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç –≤ requirements
    pip install maturin
else
    echo "‚ö†Ô∏è requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω!"
fi

# 5. –ö–æ–º–ø–∏–ª—è—Ü–∏—è Rust-—è–¥—Ä–∞ (–ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï)
RUST_SRC_DIR="$APP_DIR/bulba_rust"

if [ -d "$RUST_SRC_DIR" ]; then
    echo "‚öôÔ∏è –ö–æ–º–ø–∏–ª—è—Ü–∏—è —è–¥—Ä–∞ Bulba Rust (–º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)..."
    cd "$RUST_SRC_DIR"
    
    # –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –±–∏–ª–¥–æ–≤ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
    rm -rf target 2>/dev/null
    
    # –ö–æ–º–ø–∏–ª—è—Ü–∏—è –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ —Ç–µ–∫—É—â–µ–µ Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ
    maturin develop --release
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ –Ø–î–†–û RUST –£–°–ü–ï–®–ù–û –°–ö–û–ú–ü–ò–õ–ò–†–û–í–ê–ù–û!"
    else
        echo "‚ùå –û–®–ò–ë–ö–ê –ö–û–ú–ü–ò–õ–Ø–¶–ò–ò RUST! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥."
        exit 1
    fi
    cd "$APP_DIR"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ bulba_rust –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ $APP_DIR"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞–ø–∫–∞ 'bulba_rust' –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º —Å —ç—Ç–∏–º —Å–∫—Ä–∏–ø—Ç–æ–º."
    exit 1
fi

# 6. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤
echo "üë§ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
if [ -n "$CURRENT_USER" ] && [ "$CURRENT_USER" != "loginwindow" ]; then
    chown -R "$CURRENT_USER:staff" "$APP_DIR"
fi

chmod -R 755 "$APP_DIR"
chmod 666 "$LOG_FILE"

echo "üéâ –£–°–¢–ê–ù–û–í–ö–ê –ü–û–õ–ù–û–°–¢–¨–Æ –ó–ê–í–ï–†–®–ï–ù–ê!"
echo "‚û°Ô∏è  –î–ª—è –∑–∞–ø—É—Å–∫–∞: cd $APP_DIR && $MINIFORGE_DIR/envs/$CONDA_ENV_NAME/bin/python main.py"
exit 0
#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
APP_DIR="/Applications/BulbaGPT"
MINIFORGE_DIR="$APP_DIR/miniforge3"
CONDA_ENV_NAME="bulbagpt_env"
PYTHON_VERSION="3.11"
LOG_FILE="$APP_DIR/install_log.txt"

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É (–µ—Å–ª–∏ –Ω–µ—Ç)
mkdir -p "$APP_DIR"

# –í–∫–ª—é—á–∞–µ–º –∑–∞–ø–∏—Å—å –ª–æ–≥–∞ (stdout –∏ stderr)
exec > "$LOG_FILE" 2>&1

echo "--- –ù–ê–ß–ê–õ–û –£–°–¢–ê–ù–û–í–ö–ò: $(date) ---"
echo "–í–µ—Ä—Å–∏—è —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫–∞: 1.0"

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CURRENT_USER=$(scutil <<< "show State:/Users/ConsoleUser" | awk '/Name :/ { print $3 }')
echo "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∏—Å—Ç–µ–º—ã: $CURRENT_USER"

# 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Miniforge
if [ ! -d "$MINIFORGE_DIR" ]; then
    echo "‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Miniforge..."
    ARCH=$(uname -m)
    if [ "$ARCH" == "arm64" ]; then
        URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-arm64.sh"
    else
        URL="https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-MacOSX-x86_64.sh"
    fi
    
    curl -L -o /tmp/miniforge.sh "$URL"
    
    echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ Miniforge..."
    bash /tmp/miniforge.sh -b -u -p "$MINIFORGE_DIR"
    rm /tmp/miniforge.sh
else
    echo "‚úÖ Miniforge —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
fi

# 2. –°–æ–∑–¥–∞–Ω–∏–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üî® –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Conda –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
source "$MINIFORGE_DIR/bin/activate"

if ! conda info --envs | grep -q "$CONDA_ENV_NAME"; then
    echo "   –°–æ–∑–¥–∞–µ–º env $CONDA_ENV_NAME (Python $PYTHON_VERSION)..."
    conda create -y -n "$CONDA_ENV_NAME" python="$PYTHON_VERSION"
else
    echo "   –û–∫—Ä—É–∂–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å."
fi

# 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫
REQ_FILE="$APP_DIR/requirements.txt"
if [ -f "$REQ_FILE" ]; then
    echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ (pip install)..."
    "$MINIFORGE_DIR/envs/$CONDA_ENV_NAME/bin/pip" install -r "$REQ_FILE"
else
    echo "‚ö†Ô∏è requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $APP_DIR"
fi

# 4. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤
echo "üë§ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
if [ -n "$CURRENT_USER" ] && [ "$CURRENT_USER" != "loginwindow" ]; then
    chown -R "$CURRENT_USER:staff" "$APP_DIR"
fi

# –î–µ–ª–∞–µ–º —Ñ–∞–π–ª—ã –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º–∏
chmod -R 755 "$APP_DIR"

# –î–µ–ª–∞–µ–º –ª–æ–≥ —á–∏—Ç–∞–µ–º—ã–º –¥–ª—è –≤—Å–µ—Ö (–∏–Ω–∞—á–µ –µ–≥–æ —Å–º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å —Ç–æ–ª—å–∫–æ root)
chmod 666 "$LOG_FILE"

echo "‚úÖ –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê!"
exit 0
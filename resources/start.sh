#!/bin/bash

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cd "$(dirname "$0")/../../../" 
APP_ROOT=$(pwd)

# –ü—É—Ç–∏
MINIFORGE_DIR="$APP_ROOT/miniforge3"
CONDA_ENV_NAME="bulbagpt_env"
LOG_FILE="$APP_ROOT/runtime_log.txt"

# –í–∫–ª—é—á–∞–µ–º –∑–∞–ø–∏—Å—å –ª–æ–≥–∞
exec > "$LOG_FILE" 2>&1

echo "--- –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø: $(date) ---"
echo "–†–∞–±–æ—á–∞—è –ø–∞–ø–∫–∞: $APP_ROOT"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Miniforge
if [ ! -f "$MINIFORGE_DIR/bin/activate" ]; then
    echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: Miniforge –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ê–∫—Ç–∏–≤–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è
source "$MINIFORGE_DIR/bin/activate" "$CONDA_ENV_NAME"

# --- –§–ò–ö–° –§–û–ù–û–í–û–ì–û –ü–†–û–¶–ï–°–°–ê ---
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–±–∏–π—Å—Ç–≤–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
cleanup() {
    echo "üõë –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã..."
    # –£–±–∏–≤–∞–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã (Python)
    pkill -P $$ 
    exit
}

# –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º —Å–∏–≥–Ω–∞–ª—ã –∑–∞–∫—Ä—ã—Ç–∏—è (EXIT, SIGINT, SIGTERM)
trap cleanup EXIT SIGINT SIGTERM

# –ó–∞–ø—É—Å–∫ main.py –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ (&) —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç –º–æ–≥ –∂–¥–∞—Ç—å –∏ –ø–µ—Ä–µ—Ö–≤–∞—Ç–∏—Ç—å —Å–∏–≥–Ω–∞–ª –≤—ã—Ö–æ–¥–∞
if [ -f "main.py" ]; then
    echo "üöÄ –ó–∞–ø—É—Å–∫ main.py..."
    python -u main.py &
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–∞ Python
    PYTHON_PID=$!
    
    # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ, –ø–æ–∫–∞ –Ω–µ –∑–∞–∫—Ä–æ—é—Ç –æ–∫–Ω–æ)
    wait $PYTHON_PID
else
    echo "‚ùå main.py –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    ls -la
    exit 1
fi